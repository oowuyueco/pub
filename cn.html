<!DOCTYPE html>
<html lang="zh-CN" style="height: 100%">

<head>
    <meta charset="utf-8" />
    <script type="text/javascript" src="./js/echarts.min.js"></script>
    <script type="text/javascript" src="./js/my.js"></script>
    <script type="text/javascript" src="./js/indicatorCalculation.js"></script>
    <script type="text/javascript" src="./cn/CPI,PPI,CPI_PPI.js"></script>
    <script type="text/javascript" src="./cn/利润同比,亏损增减.js"></script>
    <script type="text/javascript" src="./cn/股债差300平均,滚动市盈率300.js"></script>
    <script type="text/javascript" src="./cn/滚动市盈率恒指.js"></script>


    <script type="text/javascript" src="./cn/沪深300PE中位数,全A股PE中位数,十年期国债利率倒数.js"></script>
    <script type="text/javascript" src="./cn/沪深300同比,上证同比.js"></script>
    <script type="text/javascript" src="./cn/财新制造业PMI,官方制造业PMI.js"></script>
    <script type="text/javascript" src="./cn/商品房销售.js"></script>
    <script type="text/javascript" src="./cn/零售汽车.js"></script>
    <script type="text/javascript" src="./cn/出口.js"></script>
    <script type="text/javascript" src="./cn/M1,M1_M2.js"></script>
    <script type="text/javascript" src="./cn/信贷脉冲,房价同比.js"></script>

    <script type="text/javascript" src="./us/MM制造业指标.js"></script>
    <script type="text/javascript" src="./us/中美利差Day,中美汇率Day.js"></script>
    <script type="text/javascript" src="./us/金融压力Day,美元指数Day.js"></script>
    <script type="text/javascript" src="./us/PMI_ISM,金融脉动增速.js"></script>
    <script type="text/javascript" src="./us/Y10日,Y2日.js"></script>
    <script type="text/javascript">
        /*
        各类资产的长期回报率是多少?  https://deepinvest.org/post/2022/09/05/the-rate-of-return-on-everything/   
        巴菲特的估值逻辑与茅台的确定性  https://shoucang.zyzhang.com/%e5%b7%b4%e8%8f%b2%e7%89%b9%e7%9a%84%e4%bc%b0%e5%80%bc%e9%80%bb%e8%be%91%e4%b8%8e%e8%8c%85%e5%8f%b0%e7%9a%84%e7%a1%ae%e5%ae%9a%e6%80%a7/
        净利润同比增长率(%)中位数 https://legulegu.com/stockdata/middle-avg-indicator?indicatorCode=netProfitYoy                           
                                   上5 
        ppi      下0         上0         高位区5下
        利亏     利下0       利上0        亏上0
    
        股市     低点        M高点1       M高点2       5-6  10-12-1-2月底
                     白马科技 红低PPI-能粮消金CPI        3年左右 

        pmi      低位        高位         高中位
        信贷     低位        高位         中下位
        美元     低位        中上位        高位



        一般        一个底部              顶部1                    顶部1

        P          下穿0 减速带最大     上穿0 加速度最大          高位5向下
        利润       下穿0 减速带最大      上穿0 加速度最大           
        亏损                                                    上穿0 加速度最大
         
        股债          低位                中上|顶                 顶|中下

        Q
        MV         内外最底部            内M最大_信贷&M1          外M最大_汇率

        */
        console.log("cn数据抓取日期=", cn抓取日期)

        let PPI_MA = PPI.chartDataMaN(4)

        官方制造业PMI = 官方制造业PMI.map(item => {
            item[1] = parseFloat(((item[1] - 50) * 1).toFixed(2))
            return item
        })
        财新制造业PMI = 财新制造业PMI.map(item => {
            item[1] = parseFloat(((item[1] - 50) * 1).toFixed(2))
            return item
        })
        let cn_pmi_平均 = 官方制造业PMI.map((item, index) => {
            let newArr = []
            newArr[0] = item[0]
            let avg
            let cx = findSameTime(财新制造业PMI, item[0])
            if (cx) avg = (item[1] * 0.5 + parseFloat(cx[1]) * 0.5).toFixed(2)
            else avg = item[1].toFixed(2)
            newArr[1] = parseFloat(avg)
            return newArr
        })

        出口 = 出口.map(((item, index, arr) => {
            if (item[0].includes("02-28")) {
                let pre = 出口[index - 1]
                let next = 出口[index + 1]
                pre = pre ? parseFloat(pre[1]) : 0
                next = next ? parseFloat(next[1]) : 0
                if ((pre * next) != 0)
                    item[1] = (pre + next) / 2
                else
                    item[1] = (pre + next)
            }
            return item
        }))
        零售汽车 = 零售汽车.map(((item, index, arr) => {
            if (item[0].includes("02-28")) {
                let pre = 零售汽车[index - 1]
                let next = 零售汽车[index + 1]
                pre = pre ? parseFloat(pre[1]) : 0
                next = next ? parseFloat(next[1]) : 0
                if ((pre * next) != 0)
                    item[1] = (pre + next) / 2
                else
                    item[1] = (pre + next)
            }
            return item
        }))
        let 零售汽车$出口 = 出口.map((output, index, datasArr) => {
            let car = 零售汽车.find(ele => ele[0] == output[0])
            let newItem = []
            if (car) {
                newItem[0] = output[0]
                newItem[1] = (parseFloat(output[1]) + parseFloat(car[1])) / 2
                return newItem
            } else {
                newItem[0] = output[0]
                newItem[1] = output[1]
                return newItem
            }
        })

        M1 = M1.map(((item, index, arr) => {
            if (item[0].includes("01-28")) {
                let pre = arr[index - 1]
                let next = arr[index + 1]
                pre = pre ? parseFloat(pre[1]) : 0
                next = next ? parseFloat(next[1]) : 0
                if ((pre * next) != 0)
                    item[1] = (pre + next) / 2
                else
                    item[1] = (pre + next)
            }
            return item
        }))
        let M1_MA = M1.chartDataMaN(4)

        M1_M2 = M1_M2.map(((item, index, arr) => {
            if (item[0].includes("01-28")) {
                let pre = arr[index - 1]
                let next = arr[index + 1]
                pre = pre ? parseFloat(pre[1]) : 0
                next = next ? parseFloat(next[1]) : 0
                if ((pre * next) != 0)
                    item[1] = (pre + next) / 2
                else
                    item[1] = (pre + next)
            }
            return item
        }))
        let M1_M2_MA = M1_M2.chartDataMaN(4)

        let 信贷脉冲_MA = 信贷脉冲.chartDataMaN(4)

        //https://finance.sina.com.cn/money/forex/hq/USDCNH.shtml
        //https://finance.sina.com.cn/money/forex/hq/DINIW.shtml
        let 中美汇率Day同比 = 中美汇率Day
            .filter((ele, index, datasArr) => {
                return true

                // var d = new Date(ele[0])
                // var n = d.getDay()
                // if(n==5) return true //周5
                // if(datasArr.length-1 == index) return true

                // currentMonth = ele[0].substring(5, 7)//月最后一天
                // if (index < datasArr.length - 1) {
                //     nextMonth = datasArr[index + 1][0].substring(5, 7)
                //     return currentMonth != nextMonth
                // } else {
                //     return true
                // }
            })
            .map((ele, index, datasArr) => { // yoY 同比
                let preYearMonthDay = '' + (parseInt(ele[0].substring(0, 4)) - 1) + ele[0].substring(4, 10)
                let preItem = datasArr.find(element => {
                    return element[0] == preYearMonthDay
                })
                if (!preItem) { //去原始数据找
                    let currentDayInt = parseInt(ele[0].substring(8, 10))
                    let preYearMonth = '' + (parseInt(ele[0].substring(0, 4)) - 1) + ele[0].substring(4, 7)
                    let n = 3
                    while (-5 < n) { //向前查找
                        let dayInt = currentDayInt + n
                        let dayStr = dayInt >= 10 ? '' + dayInt : "0" + dayInt
                        let preYearMonthDay = '' + preYearMonth + "-" + dayStr
                        preItem = datasArr.find(element => {
                            return element[0] == preYearMonthDay
                        })
                        if (preItem) break
                        n--
                    }
                }
                let yoY = ""
                if (preItem) {
                    preItem[1] = parseFloat(preItem[1])
                    ele[1] = parseFloat(ele[1])
                    yoY = preItem[1] ? ((ele[1] - preItem[1]) / preItem[1]) * 100 : ""
                }
                return [ele[0], yoY]
            })
            .map((item, index, datasArr) => {
                if (item[1] !== "") item[1] = -item[1]
                return item
                // ??????
                // if (index < datasArr.length - 1) {
                //     item[0] = item[0]
                //     item[1] = -item[1]
                // }
            })
        //中美汇率Day同比 = 中美汇率Day同比.chartDataMaN(4)

        // let 美元指数Day同比 = 美元指数Day
        //     .filter((ele, index, datasArr) => { //月最后一天
        //         // var d = new Date(ele[0])
        //         // var n = d.getDay()
        //         // if(n==5) return true //周5
        //         // if(datasArr.length-1 == index) return true

        //         return true

        //         currentMonth = ele[0].substring(5, 7)
        //         if (index < datasArr.length - 1) {
        //             nextMonth = datasArr[index + 1][0].substring(5, 7)
        //             return currentMonth != nextMonth
        //         } else {
        //             return true
        //         }
        //     })
        //     .map((ele, index, datasArr) => { // yoY 同比
        //         let preYear = '' + (parseInt(ele[0].substring(0, 4)) - 1) + ele[0].substring(4, 10)
        //         let preItem = datasArr.find(element => {
        //             return element[0] == preYear
        //         })

        //         if (!preItem) { //去原始数据找
        //             let currentDayInt = parseInt(ele[0].substring(8, 10))
        //             let preYearMonth = '' + (parseInt(ele[0].substring(0, 4)) - 1) + ele[0].substring(4, 7)
        //             let n = 7
        //             while (-7 < n) { //向前查找
        //                 let dayInt = currentDayInt + n
        //                 let dayStr = dayInt >= 10 ? '' + dayInt : "0" + dayInt
        //                 let preYearMonthDay = '' + preYearMonth + "-" + dayStr
        //                 preItem = datasArr.find(element => {
        //                     return element[0] == preYearMonthDay
        //                 })
        //                 if (preItem) break
        //                 n--
        //             }
        //         }
        //         let yoY = ""
        //         if (preItem) {
        //             preItem[1] = parseFloat(preItem[1])
        //             ele[1] = parseFloat(ele[1])
        //             yoY = preItem[1] ? (ele[1] - preItem[1]) / preItem[1] : ""
        //         }
        //         return [ele[0], yoY * 100]
        //     })
        //     .map((item, index, datasArr) => {
        //         //return item
        //         if (index < datasArr.length - 1) {
        //             item[0] = item[0]
        //             item[1] = -item[1]
        //         }
        //         return item
        //     })
        // //美元指数Day同比 = 美元指数Day同比.chartDataMaN(4)

        let 股债差恒指美债 = 滚动市盈率恒指.map(pe指数 => {
            let 美债10 = findSameTime(Y10日, pe指数[0])
            if (美债10) return [pe指数[0], 1 / pe指数[1] * 100 - parseFloat(美债10[1])]
            else {
                let currentDayInt = 28
                let yearMonth = pe指数[0].substring(0, 7)
                let n = 0
                while (-5 < n) { //向前查找
                    let dayInt = currentDayInt + n
                    let dayStr = dayInt >= 10 ? '' + dayInt : "0" + dayInt
                    let yearMonthDay = yearMonth + "-" + dayStr
                    美债10 = Y10日.find(element => {
                        return element[0] == yearMonthDay
                    })
                    if (美债10) break
                    n--
                }
                if (美债10) return [pe指数[0], 1 / pe指数[1] * 100 - parseFloat(美债10[1])]
                else return [pe指数[0], ""]
            }
        })
        //console.log("股债差恒指美债", 股债差恒指美债)

    </script>

    <script type="text/javascript" src="./cn/雪球行情/沪深300.js"></script>
    <script type="text/javascript" src="./cn/雪球行情/上证.js"></script>
    <script type="text/javascript" src="./cn/雪球行情/指数策略.js"></script>
    <script type="text/javascript" src="./cn/雪球行情/期权策略.js"></script>
    <script>

        //从后往前N 包含当前的前N个
        Array.prototype.cal9转 = function (kline交易日, priod, N = 5) {
            var candleList = this
            if (candleList.length < 20) return candleList

            for (let endIndex = candleList.length - 1; candleList.length - N <= endIndex; endIndex--) {

                if (endIndex == candleList.length - 1) {
                    if (priod == "week" && new Date(kline交易日).getDay() < 3) continue
                    if (priod == "month" && +kline交易日.substring(8, 10) < 18) continue
                }

                let is9转up = true
                let is9转down = true
                for (var i = 0; i <= 8; i++) {
                    is9转down = is9转down && (candleList[endIndex - i - 4].close > candleList[endIndex - i].close)
                    is9转up = is9转up && (candleList[endIndex - i - 4].close < candleList[endIndex - i].close)
                }

                if (is9转up) {
                    for (var i = 0; i <= 8; i++)
                        candleList[endIndex - i]["is9转up"] = 9 - i
                    //break
                }
                if (is9转down) {
                    for (var i = 0; i <= 8; i++)
                        candleList[endIndex - i]["is9转down"] = 9 - i
                    //break
                }
            }

            return candleList
        }

        ///指数策略/////////////////
        function toChartDataByDay() {
            let 指数策略ByDay = []

            let trigDateArr = Object.keys(triggerLogObj指数.按日期排序).sort((a, b) => dateToStamp(b) - dateToStamp(a))
            for (let index = 0; index < trigDateArr.length; index++) {
                let date = trigDateArr[index];
                let eleArr = triggerLogObj指数.按日期排序[date]
                let trig策略s = eleArr.toSpliced(-1, 1)
                let profileN = eleArr[eleArr.length - 1]
                let type = profileN?.标星 ? profileN?.标星 : (trig策略s[0].includes("高位") ? "高位" : "低位")
                if (Object.keys(profileN).length <= 0) continue

                let byDateArr = [date, trig策略s.length, trig策略s, type, profileN]
                指数策略ByDay.push(byDateArr)
            }
            return 指数策略ByDay
        }

        function toByDay过滤后N天(N = 10) {

            let 指数策略ByDay过滤后N天 = []
            let trigDateArr = Object.keys(triggerLogObj指数.按日期排序).sort((a, b) => dateToStamp(b) - dateToStamp(a))

            for (let index = trigDateArr.length - 1; index >= 0; index--) {
                let date = trigDateArr[index];
                let eleArr = triggerLogObj指数.按日期排序[date]
                let trig策略s = eleArr.toSpliced(-1, 1)
                let profileN = eleArr[eleArr.length - 1]
                let type = profileN?.标星 ? profileN?.标星 : (trig策略s[0].includes("高位") ? "高位" : "低位")

                if (Object.keys(profileN).length <= 0) continue

                let byDateArr = [date, trig策略s.length, trig策略s, type, profileN]

                if (指数策略ByDay过滤后N天.length == 0)//continue 去掉一个！！
                    指数策略ByDay过滤后N天.unshift(byDateArr)
                else if (dateToStamp(date) >= dateToStamp(指数策略ByDay过滤后N天[0][0]) + N * 86400000) //过滤后N天 1号后N天过滤掉
                    指数策略ByDay过滤后N天.unshift(byDateArr)
            }
            return 指数策略ByDay过滤后N天
        }

        function toByDay统计前N天(N = 5) {

            let 指数策略ByDay统计前N天 = []
            let trigDateArr = Object.keys(triggerLogObj指数.按日期排序).sort((a, b) => dateToStamp(b) - dateToStamp(a))

            for (let index = trigDateArr.length - 1; index >= 0; index--) {
                let date = trigDateArr[index];
                let eleArr = triggerLogObj指数.按日期排序[date]
                let trig策略s = eleArr.toSpliced(-1, 1)
                let profileN = eleArr[eleArr.length - 1]
                let type = profileN?.标星 ? profileN?.标星 : (trig策略s[0].includes("高位") ? "高位" : "低位")

                if (Object.keys(profileN).length <= 0) continue

                let 包含当天最近N天触发的日期 = trigDateArr.filter(eledate => dateToStamp(date) >= dateToStamp(eledate) && dateToStamp(eledate) >= dateToStamp(date) - N * 86400000)

                let 包含当天最近N天触发的 = 包含当天最近N天触发的日期.map((itemDate) => {
                    let eleArr = triggerLogObj指数.按日期排序[itemDate]
                    let trig策略s = eleArr.toSpliced(-1, 1)
                    let profileN = eleArr[eleArr.length - 1]
                    let type = profileN?.标星 ? profileN?.标星 : (trig策略s[0].includes("高位") ? "高位" : "低位")

                    return [itemDate, trig策略s, profileN]
                })

                let 前N天策略总数 = 0
                包含当天最近N天触发的.forEach(element => { 前N天策略总数 += element[1].length })

                let next1DateSplitArr = profileN?.nextFirstDelivery周三 ? profileN.nextFirstDelivery周三.close.split("->") : ""
                let next1kline = [
                    0,//open
                    profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.high.split(",")[2] : +profileN.after.high.split(",")[2],//up
                    profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.low.split(",")[2] : +profileN.after.low.split(",")[2],//low
                    profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.close.split(",")[2] : +profileN.after.close.split(",")[2],//close

                    profileN.nextFirstDelivery周三 ?
                        `${next1DateSplitArr[0]}后1周三` + next1DateSplitArr[1].split(",")[0] :
                        `after${profileN.after.close.split("->")[0]}`,

                    profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.close.split(",")[1] : +profileN.after.close.split(",")[1],//close 点位变化
                ]

                let next2DateSplitArr = profileN?.nextSecondDelivery周三 ? profileN.nextSecondDelivery周三.close.split("->") : ""
                let next2kline = [
                    0,//open
                    profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.high.split(",")[2] : +profileN.after.high.split(",")[2],//up
                    profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.low.split(",")[2] : +profileN.after.low.split(",")[2],//low
                    profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.close.split(",")[2] : +profileN.after.close.split(",")[2],//close

                    profileN.nextSecondDelivery周三 ?
                        `${next2DateSplitArr[0]}后2周三` + next2DateSplitArr[1].split(",")[0] :
                        `after${profileN.after.close.split("->")[0]}`,

                    profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.close.split(",")[1] : +profileN.after.close.split(",")[1],//close 点位变化
                ]

                let byDateArr = [date, 前N天策略总数, 包含当天最近N天触发的, type, ...next2kline]
                指数策略ByDay统计前N天.push(byDateArr)
            }

            return 指数策略ByDay统计前N天.sort((a, b) => dateToStamp(b[0]) - dateToStamp(a[0]))
        }

        function toBy期权日(nextN期权周三) {
            let 指数策略By期权 = {}
            let trigDateArr = Object.keys(triggerLogObj指数.按日期排序).sort((a, b) => dateToStamp(b) - dateToStamp(a))

            for (let index = 0; index < trigDateArr.length; index++) {
                let date = trigDateArr[index];
                let eleArr = triggerLogObj指数.按日期排序[date]
                let trig策略s = eleArr.toSpliced(-1, 1)
                let profileN = eleArr[eleArr.length - 1]
                let type = profileN?.标星 ? profileN?.标星 : (trig策略s[0].includes("高位") ? "高位" : "低位")

                if (Object.keys(profileN).length <= 0) continue

                let key
                let N = nextN期权周三 == "nextFirstDelivery周三" ? 1 : 2
                if (profileN[nextN期权周三]) {
                    key = `${type}_后${N}周三` + profileN[nextN期权周三].close.split("->")[1].split(",")[0]
                }
                else {
                    key = N == 1 ? `${type}_后${N}周三` + profileN.after.nextFirstDelivery周三 : `${type}_后${N}周三` + profileN.after.nextSecondDelivery周三
                }

                let byDateArr = [date, trig策略s.length, trig策略s, type, profileN]
                if (指数策略By期权.hasOwnProperty(key))
                    指数策略By期权[key].push(byDateArr)
                else
                    指数策略By期权[key] = [byDateArr]
            }
            return 指数策略By期权
        }

        let 指数策略ByDay = toChartDataByDay()
        let 指数策略ByDay过滤后N天 = toByDay过滤后N天(10)
        let 指数策略ByDay统计前N天 = toByDay统计前N天(5)
        let 指数策略By后一期权日 = toBy期权日("nextFirstDelivery周三")
        let 指数策略By后二期权日 = toBy期权日("nextSecondDelivery周三")

        let 指数策略高位ByDay = 指数策略ByDay.filter(item => item[3].includes("高位")).map(item => [item[0], item[2], item[3], item[4]])
        let 指数策略低位ByDay = 指数策略ByDay.filter(item => item[3].includes("低位")).map(item => [item[0], item[2], item[3], item[4]])

        let 指数策略高位ByDay过滤后N天 = 指数策略ByDay过滤后N天.filter(item => item[3].includes("高位")).map(item => [item[0], item[2], item[4]])
        let 指数策略低位ByDay过滤后N天 = 指数策略ByDay过滤后N天.filter(item => item[3].includes("低位")).map(item => [item[0], item[2], item[4]])

        let 指数策略高位ByDay统计前N天 = 指数策略ByDay统计前N天.filter(item => item[3].includes("高位"))//.map(item => [item[0], item[2]])
        let 指数策略低位ByDay统计前N天 = 指数策略ByDay统计前N天.filter(item => item[3].includes("低位"))

        //Object.fromEntries()
        let 指数策略高位By后一期权日 = Object.entries(指数策略By后一期权日).filter(([key, byDayArr]) => key.includes("高位")).map(([key, byDayArr]) => {
            byDayArr = byDayArr.map(item => [item[0], item[2], item[4]])
            let n天策略总数 = 0
            byDayArr.forEach(element => { n天策略总数 += element[1].length })
            return [key.replace("高位_", ""), n天策略总数, byDayArr]
        })
        let 指数策略低位By后一期权日 = Object.entries(指数策略By后一期权日).filter(([key, byDayArr]) => key.includes("低位")).map(([key, byDayArr]) => {
            byDayArr = byDayArr.map(item => [item[0], item[2], item[4]])
            let n天策略总数 = 0
            byDayArr.forEach(element => { n天策略总数 += element[1].length })
            return [key.replace("低位_", ""), n天策略总数, byDayArr]
        })

        let 指数策略高位By后二期权日 = Object.entries(指数策略By后二期权日).filter(([key, byDayArr]) => key.includes("高位")).map(([key, byDayArr]) => {
            byDayArr = byDayArr.map(item => [item[0], item[2], item[4]])
            let n天策略总数 = 0
            byDayArr.forEach(element => { n天策略总数 += element[1].length })
            return [key.replace("高位_", ""), n天策略总数, byDayArr]
        })
        let 指数策略低位By后二期权日 = Object.entries(指数策略By后二期权日).filter(([key, byDayArr]) => key.includes("低位")).map(([key, byDayArr]) => {
            byDayArr = byDayArr.map(item => [item[0], item[2], item[4]])
            let n天策略总数 = 0
            byDayArr.forEach(element => { n天策略总数 += element[1].length })
            return [key.replace("低位_", ""), n天策略总数, byDayArr]
        })

        console.log("沪深300最新日期=", 沪深300[沪深300.length - 1])
        console.log("指数策略高位", 指数策略高位ByDay, 指数策略高位ByDay统计前N天, 指数策略高位By后二期权日)
        console.log("指数策略低位", 指数策略低位ByDay, 指数策略低位ByDay统计前N天, 指数策略低位By后二期权日)


        //期权策略///////////
        function 区间toByDay统计前N天(区间类型 = "上升日期区间", N = 0) {

            let 区间ByDay统计前N天 = {}
            区间ByDay统计前N天.All = []

            let 日期区间Arr = Object.keys(triggerLogObj期权[区间类型])
            for (let index = 日期区间Arr.length - 1; index >= 0; index--) {

                let 日期区间 = 日期区间Arr[index]
                let triggerDaysObj = triggerLogObj期权[区间类型][日期区间]

                let 区间内触发日期Arr = Object.keys(triggerDaysObj)
                for (let ii = 区间内触发日期Arr.length - 1; ii >= 0; ii--) {
                    let triggerDate = 区间内触发日期Arr[ii]

                    let triggerEleArr = triggerLogObj期权[区间类型][日期区间][triggerDate]
                    let trig策略s = triggerEleArr.toSpliced(-1, 1).map((item) => { return item.quantName })
                    let profileN = triggerEleArr[triggerEleArr.length - 1]

                    let 包含当天最近N天触发的日期 = 区间内触发日期Arr.filter(eledate => dateToStamp(triggerDate) >= dateToStamp(eledate) && dateToStamp(eledate) >= dateToStamp(triggerDate) - N * 86400000)
                    let 包含当天最近N天触发的 = 包含当天最近N天触发的日期.map((itemDate) => {
                        let eleArr = triggerLogObj期权[区间类型][日期区间][itemDate]
                        let trig策略s = eleArr.toSpliced(-1, 1).map((item) => { return item.quantName })
                        let profileN = eleArr[eleArr.length - 1]
                        return [itemDate, trig策略s, profileN]
                    })
                    let 前N天策略总数 = 0
                    包含当天最近N天触发的.forEach(element => { 前N天策略总数 += element[1].length })

                    let next1DateSplitArr = profileN?.nextFirstDelivery周三 ? profileN.nextFirstDelivery周三.close.split("->") : ""
                    let next1kline = [
                        0,//open
                        profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.high.split(",")[2] : +profileN.after.high.split(",")[2],//up
                        profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.low.split(",")[2] : +profileN.after.low.split(",")[2],//low
                        profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.close.split(",")[2] : +profileN.after.close.split(",")[2],//close

                        profileN.nextFirstDelivery周三 ?
                            `${next1DateSplitArr[0]}后1周三` + next1DateSplitArr[1].split(",")[0] :
                            `after${profileN.after.close.split("->")[0]}`,

                        profileN?.nextFirstDelivery周三 ? +profileN.nextFirstDelivery周三.close.split(",")[1] : +profileN.after.close.split(",")[1],//close 点位变化

                        triggerEleArr.toSpliced(-1, 1).reduce((previous, current) => {
                            return previous + current.quantName + "_" + current.logInfo + " ; "
                        }, "")

                    ]

                    let next2DateSplitArr = profileN?.nextSecondDelivery周三 ? profileN.nextSecondDelivery周三.close.split("->") : ""
                    let next2kline = [
                        0,//open
                        profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.high.split(",")[2] : +profileN.after.high.split(",")[2],//up
                        profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.low.split(",")[2] : +profileN.after.low.split(",")[2],//low
                        profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.close.split(",")[2] : +profileN.after.close.split(",")[2],//close

                        profileN.nextSecondDelivery周三 ?
                            `${next2DateSplitArr[0]}后2周三` + next2DateSplitArr[1].split(",")[0] :
                            `after${profileN.after.close.split("->")[0]}`,

                        profileN.nextSecondDelivery周三 ? +profileN.nextSecondDelivery周三.close.split(",")[1] : +profileN.after.close.split(",")[1],//close 点位变化

                        triggerEleArr.toSpliced(-1, 1).reduce((previous, current) => {
                            return previous + current.quantName + "_" + current.logInfo + " ; "
                        }, "")
                    ]

                    let byDateArr = [triggerDate, 前N天策略总数, 包含当天最近N天触发的, ...next2kline]

                    if (typeof 区间ByDay统计前N天[日期区间] !== "undefined") 区间ByDay统计前N天[日期区间].push(byDateArr)
                    else 区间ByDay统计前N天[日期区间] = [byDateArr]

                    区间ByDay统计前N天.All.push(byDateArr)
                }
            }
            // (a, b) => a[3] - b[3]
            // a[5].localeCompare(b[5], 'zh-Hans-CN', { sensitivity: 'accent' })
            // dateToStamp(a[0]) - dateToStamp(b[0])
            区间ByDay统计前N天.All.sort((a, b) => b[8] - a[8])
            return 区间ByDay统计前N天
        }

        function 区间toBy期权日(区间类型 = "上升日期区间", nextN期权周三 = "nextFirstDelivery周三",) {

            let 区间By期权日 = {}

            let 日期区间Arr = Object.keys(triggerLogObj期权[区间类型])
            for (let index = 日期区间Arr.length - 1; index >= 0; index--) {

                let 日期区间 = 日期区间Arr[index]
                区间By期权日[日期区间] = {}
                let triggerDaysObj = triggerLogObj期权[区间类型][日期区间]

                let 区间内触发日期Arr = Object.keys(triggerDaysObj).sort((a, b) => dateToStamp(b) - dateToStamp(a))

                for (let ii = 区间内触发日期Arr.length - 1; ii >= 0; ii--) {
                    let triggerDate = 区间内触发日期Arr[ii]
                    let triggerEleArr = triggerLogObj期权[区间类型][日期区间][triggerDate]
                    let trig策略s = triggerEleArr.toSpliced(-1, 1).map((item) => { return item.quantName })
                    let profileN = triggerEleArr[triggerEleArr.length - 1]

                    let key
                    let N = nextN期权周三 == "nextFirstDelivery周三" ? 1 : 2
                    if (profileN[nextN期权周三]) {
                        key = `后${N}周三` + profileN[nextN期权周三].close.split("->")[1].split(",")[0]
                    }
                    else {
                        key = N == 1 ? `后${N}周三` + profileN.after.nextFirstDelivery周三 : `${type}_后${N}周三` + profileN.after.nextSecondDelivery周三
                    }

                    let byDateArr = [triggerDate, trig策略s.length, trig策略s, profileN]


                    if (区间By期权日[日期区间].hasOwnProperty(key))
                        区间By期权日[日期区间][key].push(byDateArr)
                    else {
                        区间By期权日[日期区间][key] = [byDateArr]
                    }

                }
            }

            return 区间By期权日//.sort((a, b) => dateToStamp(b[0]) - dateToStamp(a[0]))
        }

        console.log("上升区间", 区间toByDay统计前N天(), 区间toBy期权日())
        console.log("下降区间", 区间toByDay统计前N天("下降日期区间"), 区间toBy期权日("下降日期区间"))
    </script>

</head>

<body style="height: 100%; width: 100%; margin: 0">
    <div id="container" style="height: 100%; width: 100%;"></div>
    <script type="text/javascript">
        Array.prototype.addStartEnd = function () {
            let arr = this
            let startYear = 2000
            if (arr.length > 0 && Date.parse(arr[0][0]) < Date.parse(`${startYear}-01-01`))
                arr = arr.filter(item => {
                    return parseFloat(item[0].substring(0, 4)) >= startYear
                })


            arr = [
                [`${startYear}-01-01`, ""]
            ].concat(arr)

            let last300Day = 沪深300[沪深300.length - 1].date
            if (+last300Day.substring(5, 7) <= 7)
                var chartLastDay = last300Day.substring(0, 4) + "-12-28"
            else
                var chartLastDay = +last300Day.substring(0, 4) + 1 + "-12-28"

            arr.push([chartLastDay, ""])

            return arr
        }

        var dom = document.getElementById("container");
        var myChart = echarts.init(dom, "red", {
            renderer: "canvas",
            useDirtyRect: false,
        });
        var app = {};
        var option;

        let gridbackgroundColor = "#f7f9fa"
        let splitLineColor = "#d8d8d8"
        let grid默认 = [
            { //ppi
                left: 60,
                right: 80,
                top: "0%",
                height: '17%',
                show: true,

            },

            { //利润亏损
                left: 60,
                right: 80,
                top: "17%",
                height: '18%',
                show: true,

            },

            { //股债  
                left: 60,
                right: 80,
                top: "35%",
                height: '23%',
                show: true,
            },
            { //策略 
                left: 60,
                right: 80,
                top: "35%",
                height: '23%', // 23 or 43  
                show: true,
            },
            { //股同比
                left: 60,
                right: 80,
                top: "58%",
                height: '20%',
                show: true,
            },
            { //指数
                left: 60,
                right: 80,
                top: "35%",
                height: '43%', // 23 or 43  
                show: true,
            },


            { //PMI
                left: 60,
                right: 80,
                top: "58%",
                height: '20%',
                show: true,
            },

            { //M12 信贷
                left: 60,
                right: 80,
                top: "78%",
                height: '20%',
                show: true,
                //backgroundColor: gridbackgroundColor,
            },
        ]
        let grid全屏 = [
            { //ppi
                left: 60,
                right: 80,
                top: "0%",
                height: '17%',
                show: true,

            },

            { //利润亏损
                left: 60,
                right: 80,
                top: "17%",
                height: '18%',
                show: true,

            },

            { //股债  
                left: 60,
                right: 80,
                top: "35%",
                height: '15%',
                show: true,
            },
            { //策略 
                left: 60,
                right: 80,
                top: "35%",
                height: '15%', // 23 or 43  
                show: true,
            },
            { //股同比
                left: 60,
                right: 80,
                top: "50%",
                height: '13%',
                show: true,
            },
            { //指数
                left: 60,
                right: 80,
                top: "35%",
                height: '28%', // 23 or 43  
                show: true,
            },


            { //PMI
                left: 60,
                right: 80,
                top: "63%",
                height: '17%',
                show: true,
            },

            { //M12 信贷
                left: 60,
                right: 80,
                top: "80%",
                height: '18%',
                show: true,
                //backgroundColor: gridbackgroundColor,  98
            },
        ]

        option = {
            title: {},
            tooltip: {
                trigger: "axis",
                show: true,
                position: ["3%", "23.5%"],
                order: "seriesDesc",
                formatter: function (params, ticket, callback) {
                    return null;
                },
                axisPointer: {
                    type: "cross",
                    show: true,
                    crossStyle: {
                        width: 0.6,
                        color: "black", // 鼠标十字横轴
                    },
                },
            },
            legend: {
                inactiveColor: '#9a9393',
                left: "0.5%",
                top: "-0.5%"

            },
            axisPointer: {
                type: "cross",
                show: true,
                link: [{
                    xAxisIndex: "all",
                },],
                lineStyle: {
                    color: "black", // 鼠标十字竖轴
                    lineStyle: {
                        width: 0.6,
                        color: "black", // 鼠标十字竖轴
                    },
                },
            },
            dataZoom: [

                {
                    show: true,
                    realtime: true,
                    start: 0,
                    end: 100,
                    xAxisIndex: [0, 1, 2, 3, 4, 5, 6, 7],
                    bottom: -15,
                },
            ],

            grid: grid默认,

            xAxis: [

                { //ppi
                    gridIndex: 0,
                    type: "time",
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true,
                        label: {
                            show: true,
                        },
                    },
                    axisLabel: {
                        fontSize: 10,
                        formatter: "{yyyy}",
                        padding: [0, -50, 0, 0],
                    },
                },

                { //利润亏损
                    gridIndex: 1,
                    type: "time",
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true,
                        label: {
                            show: false,
                        },
                    },
                    axisLabel: {
                        show: false
                    }
                },

                { //股债  
                    gridIndex: 2,
                    type: 'time',
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true, // 抓数据圆圈
                        label: {
                            show: false, //黑框日期
                        },
                    },
                    axisLabel: {
                        show: false
                    }
                },
                { //策略
                    gridIndex: 3,
                    type: "time",
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true,
                        label: {
                            show: false,
                        },
                    },
                    axisLabel: {
                        show: false
                    }
                },
                { //股同比
                    gridIndex: 4,
                    type: 'time',
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true,
                        label: {
                            show: false,
                        },
                    },
                    axisLabel: {
                        show: false
                    }
                },
                { //指数  
                    gridIndex: 5,
                    type: 'time',
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true, // 抓数据圆圈
                        label: {
                            show: false, //黑框日期
                        },
                    },
                    axisLabel: {
                        show: false
                    }
                },

                { //PMI
                    gridIndex: 6,
                    type: "time",
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true,
                        label: {
                            show: false,
                        },
                    },
                    axisLabel: {
                        show: false
                    }
                },

                { //M12 信贷
                    gridIndex: 7,
                    type: "time",
                    splitNumber: 20,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: [splitLineColor]
                        }
                    },
                    axisPointer: {
                        show: true,
                        label: {
                            show: false,
                        },
                    },
                    axisLabel: {
                        show: false
                    }
                },

            ],

            yAxis: [

                { //ppi
                    gridIndex: 0,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        formatter: (value, index) => {
                            if (value <= -10) return ""
                            else return value
                        }
                    },
                    position: "right",
                },
                {
                    gridIndex: 0,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    position: "left",
                },

                { //利润亏损
                    gridIndex: 1,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        formatter: (value, index) => {
                            if (value > 60 || value < -20) return ""
                            else return value
                        }
                    },
                    position: "right",
                    max: 65,
                    min: -35
                },
                {
                    gridIndex: 1,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    position: "left",
                },

                { //股债  
                    gridIndex: 2,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    position: "right",
                    inverse: true, //默认现实平均
                    interval: 3,
                    max: 8.5,
                    min: 0,
                },
                {
                    gridIndex: 2,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        formatter: (value, index) => {
                            if (value > 700) return value / 1000 + "K"
                            else return value
                        }
                    },
                    position: "left",
                    min: 700
                },
                { //策略
                    gridIndex: 3,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        show: false
                    },
                    max: 20,
                    position: "right",
                },
                {
                    gridIndex: 3,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    position: "left",
                },
                { //股同比 
                    gridIndex: 4,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        formatter: (value, index) => {
                            if ([-10, 10].includes(value)) return value
                            else return ""
                        }
                    },
                    interval: 5,
                    max: 50,
                    min: -25,
                    position: "right",
                },
                {
                    gridIndex: 4,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    position: "left",
                },
                { //指数
                    gridIndex: 5,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        formatter: (value, index) => {
                            if (value > 700) return value / 1000 + "K"
                            else return value
                        }
                    },
                    position: "left",
                    min: 700
                },
                {
                    gridIndex: 5,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    position: "right",
                },

                { //PMI 
                    gridIndex: 6,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        formatter: (value, index) => {
                            if ([-10, 10].includes(value)) return value
                            else return ""
                        }
                    },
                    interval: 5,
                    max: 50,
                    min: -25,
                    position: "right",
                },
                {
                    gridIndex: 6,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    position: "left",
                },

                { //信贷 右侧列数据
                    gridIndex: 7,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    axisLabel: {
                        formatter: (value, index) => {
                            if (value >= 40) return ""
                            else return value
                        }
                    },
                    position: "right",
                    max: 40,
                    min: 20,
                },
                { //M1_M2  金融脉动us  美元指数 左侧列数据 
                    gridIndex: 7,
                    type: 'value',
                    splitLine: {
                        show: false
                    },
                    interval: 10,
                    axisLabel: {
                        formatter: (value, index) => {
                            if (value > 30) return ""
                            else return value
                        },
                        color: "black"
                    },
                    position: "left",
                    max: 25,
                    min: -20
                },

            ],

            series: [

                { //ppi
                    name: "ppi",
                    type: "line",
                    xAxisIndex: 0,
                    yAxisIndex: 0,
                    showSymbol: false,
                    lineStyle: {
                        width: 1.5,
                    },
                    itemStyle: {
                        normal: {
                            color: {
                                type: "linear",
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0.95,
                                    color: "#0079cd" //"#0081B6",
                                },

                                {
                                    offset: 0.25,
                                    color: "#FD4142" //"#FD4142",
                                },
                                ],
                                globalCoord: true,
                            },
                        },
                    },
                    markLine: {
                        symbol: ["none", "none"],
                        data: [{
                            lineStyle: {
                                width: 0.5,
                                color: "#ff535c",
                            },
                            label: {
                                formatter: "上下穿5",
                                color: "#ff535c",
                                fontSize: 10,
                                position: "insideStartTop",
                            },
                            yAxis: 5, // 标线值
                        },

                        {
                            lineStyle: {
                                width: 0.5,
                                color: "black",
                            },
                            label: {
                                formatter: "0",
                                color: "#0081B6",
                                fontSize: 10,
                                position: "insideStartBottom",
                            },
                            yAxis: 0, // 标线值
                        },
                        ],
                    },
                    tooltip: {
                        show: true,
                    },
                    data: PPI.addStartEnd(),
                },

                { //利润亏损
                    name: '红利$蓝亏',
                    type: 'line',
                    xAxisIndex: 1,
                    yAxisIndex: 2,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: "#FD4142", //"#fd76c8"
                    },
                    data: 利润同比.addStartEnd()
                },
                {
                    name: '红利$蓝亏',
                    type: 'line',
                    xAxisIndex: 1,
                    yAxisIndex: 2,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: "#0081B6", //"#007c71",
                    },
                    data: 亏损增减.addStartEnd()
                },


                { //股债
                    name: "股债差",
                    type: "line",
                    xAxisIndex: 2,
                    yAxisIndex: 4,
                    data: 股债差300平均.filter((item) => {
                        return parseFloat(item[0].substring(0, 4)) >= 2007;
                    }).addStartEnd(),
                    showSymbol: false,
                    lineStyle: {
                        width: 1.5,
                    },
                    zlevel: 1,
                    itemStyle: {
                        normal: {
                            color: {
                                type: "linear",
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0.4,
                                    color: "red",
                                },
                                {
                                    offset: 0.6,
                                    color: "orange",
                                },

                                {
                                    offset: 0.8,
                                    color: "green",
                                },
                                ],
                                globalCoord: true,
                            },
                        },
                    },
                    markLine: {
                        symbol: ["none", "none"],
                        data: [{
                            lineStyle: {
                                width: 0.5,
                                color: "green",
                            },
                            label: {
                                formatter: "6低估",
                                fontSize: "10",
                                color: "green",
                                position: "start",
                            },
                            yAxis: 6, // 标线值
                            x: "6.5%", //固定起点的 x 像素位置
                        },
                        {
                            lineStyle: {
                                width: 0.5,
                                color: "red",
                            },
                            label: {
                                formatter: "3高估",
                                fontSize: "10",
                                color: "red",
                                position: "start",
                            },
                            yAxis: 3, // 标线值
                            x: "6.5%",
                        },

                            // {
                            //     lineStyle: {
                            //         width: 0,
                            //         color: "#ff000000",
                            //         type: "solid" // 实线，不写默认虚线
                            //     },

                            //     yAxis: 0, // 标线值

                            // },
                        ],
                    },
                },
                {
                    name: '恒指美债差',
                    type: 'line',
                    xAxisIndex: 2,
                    yAxisIndex: 4,
                    showSymbol: false,
                    lineStyle: {
                        width: 1.7,
                        type: "dotted"
                    },
                    zlevel: 1,
                    itemStyle: {
                        normal: {
                            color: {
                                type: "linear",
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0.4,   //小上移  大下移
                                    color: "red",
                                },
                                {
                                    offset: 0.5,
                                    color: "orange",
                                },

                                {
                                    offset: 0.7,
                                    color: "green",
                                },
                                ],
                                globalCoord: true,
                            },
                        },
                    },

                    data: 股债差恒指美债.filter((item) => {
                        return parseFloat(item[0].substring(0, 4)) >= 2007;
                    }).addStartEnd(),
                },

                {
                    name: "中位PE", //紫色 300PE中位数
                    type: "line",
                    xAxisIndex: 2,
                    yAxisIndex: 4,
                    data: 沪深300PE中位数.map(ele => {
                        return [ele[0], (1 / parseFloat(ele[1]) * 100).toFixed(2)]
                    }).addStartEnd(),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1.1,
                        color: "#b749fd",
                    },
                    zlevel: 1,
                    markLine: {
                        symbol: ["none", "none"],
                        data: [{
                            lineStyle: {
                                width: 0,
                                color: "#ff535c",
                            },
                            label: {
                                position: "start",
                                formatter: "30高估",
                                fontSize: "10",
                                color: "#ff535c",
                            },
                            yAxis: 3.5,
                            x: "7%", //固定起点的 x 像素位置
                        },
                        {
                            lineStyle: {
                                width: 0.7,
                                color: "green",
                            },
                            label: {
                                position: "start",
                                formatter: "20低估",
                                fontSize: "10",
                                color: "green",
                            },
                            yAxis: 5,
                            x: "7%", //固定起点的 x 像素位置
                        },
                        ],
                    },
                },
                {
                    name: "中位PE", //橘色 全a剔除后中位
                    type: "line",
                    xAxisIndex: 2,
                    yAxisIndex: 4,
                    zlevel: 1,
                    data: 全A股PE中位数.map(ele => {
                        return [ele[0], (1 / parseFloat(ele[1]) * 100).toFixed(2)]
                    }).addStartEnd(),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1.1,
                        color: "#ff814f",
                    },
                },
                {
                    name: "中位PE", //十年前国债收益率
                    type: "line",
                    xAxisIndex: 2,
                    yAxisIndex: 4,
                    zlevel: 1,
                    data: 十年期国债利率倒数.map(ele => {
                        return [ele[0], (1 / parseFloat(ele[1]) * 100).toFixed(2)]
                    }).addStartEnd(),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1.1,
                        color: "black",
                    },
                },
                {
                    name: "美债", //美十年前国债收益率
                    type: "line",
                    xAxisIndex: 2,
                    yAxisIndex: 4,
                    zlevel: 1,
                    data: Y10日.filter((ele, index, datasArr) => { //月最后一天
                        // var d = new Date(ele[0])
                        // var n = d.getDay()
                        // if(n==5) return true //周5
                        // if(datasArr.length-1 == index) return true
                        // return true
                        currentMonth = ele[0].substring(5, 7)
                        if (index < datasArr.length - 1) {
                            nextMonth = datasArr[index + 1][0].substring(5, 7)
                            return currentMonth != nextMonth
                        } else {
                            return true
                        }
                    })
                        .map(ele => {
                            return [ele[0], (parseFloat(ele[1])).toFixed(2)]
                        }).filter((item) => {
                            return parseFloat(item[0].substring(0, 4)) >= 2005;
                        }).addStartEnd(),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        type: 'dotted',
                        width: 1,
                        color: "black",
                    },
                },


                { //策略
                    name: '大盘策略',
                    type: 'scatter',
                    xAxisIndex: 3,
                    yAxisIndex: 6,
                    symbol: 'path://M 200 200 l-40 100 100 -80 -120 0 100 80 -40 -120 -40 120z',
                    itemStyle: {
                        normal: {
                            opacity: 1,
                            color: "red"
                        }
                    },
                    symbolSize: function (val) {
                        return 8
                    },
                    zlevel: 3,
                    data: 指数策略高位ByDay.filter((item) => {
                        return item[2].includes("★")
                    }).map((item) => {
                        return [item[0], item[1].length, item[1]]
                    }).addStartEnd()
                },

                { //策略
                    name: '大盘策略',
                    type: 'scatter',
                    xAxisIndex: 3,
                    yAxisIndex: 6,
                    symbol: "pin",
                    itemStyle: {
                        normal: {
                            opacity: 1,
                            color: "red"
                        }
                    },
                    symbolSize: function (val) {
                        return 8
                    },
                    zlevel: 3,
                    data: 指数策略高位ByDay.filter((item) => {
                        return !item[2].includes("★")
                    }).map((item) => {
                        return [item[0], item[1].length, item[1]]
                    }).addStartEnd()
                },

                { //策略
                    name: '大盘策略',
                    type: 'scatter',
                    xAxisIndex: 3,
                    yAxisIndex: 6,
                    symbol: 'path://M 200 200 l-40 100 100 -80 -120 0 100 80 -40 -120 -40 120z',
                    itemStyle: {
                        normal: {
                            opacity: 1,
                            color: "#003900"
                        }
                    },
                    symbolSize: function (val) {
                        return 8
                    },
                    zlevel: 3,
                    data: 指数策略低位ByDay.filter((item) => {
                        return item[2].includes("★")
                    }).map((item) => {
                        return [item[0], item[1].length, item[1]]
                    }).addStartEnd()
                },

                {
                    name: '大盘策略',
                    type: 'scatter',
                    xAxisIndex: 3,
                    yAxisIndex: 6,
                    symbol: "pin",
                    itemStyle: {
                        normal: {
                            opacity: 1,
                            color: "#003900"
                        }
                    },
                    symbolSize: function (val) {
                        return 8
                    },
                    zlevel: 3,
                    data: 指数策略低位ByDay.filter((item) => {
                        return !item[2].includes("★")
                    }).map((item) => {
                        return [item[0], item[1].length, item[1]]
                    }).addStartEnd()
                },

                { //股同比
                    name: "300同比",
                    type: "line",
                    xAxisIndex: 4,
                    yAxisIndex: 8,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1.3,
                    },
                    zlevel: 1,
                    tooltip: {
                        show: false,
                    },
                    itemStyle: {
                        normal: {
                            color: {
                                type: "linear",
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0.45, //大 下
                                    color: "red",
                                },
                                {
                                    offset: 0.6,
                                    color: "orange",
                                },

                                {
                                    offset: 0.8, //小 上
                                    color: "green",
                                },
                                ],
                                globalCoord: true,
                            },
                        },
                    },
                    markLine: {
                        symbol: ["none", "none"],
                        data: [{
                            lineStyle: {
                                width: 0.5,
                                color: "green",
                            },
                            label: {
                                formatter: "-20低估",
                                color: "green",
                                fontSize: "10",
                                position: "start",
                            },
                            yAxis: -20, // 标线值
                            x: "6.5%", //固定起点的 x 像素位置
                        },
                        {
                            lineStyle: {
                                width: 0.5,
                                color: "red",
                            },
                            label: {
                                formatter: "30高估",
                                color: "red",
                                fontSize: "10",
                                position: "start",
                            },
                            yAxis: 30, // 标线值
                            x: "6.5%",
                        },
                        {
                            lineStyle: {
                                width: 0.5,
                                color: "gray",
                                //type: "solid" // 实线，不写默认虚线
                            },
                            label: {
                                formatter: "30高估",
                                color: "red",
                                fontSize: "0",
                                position: "start",
                            },
                            yAxis: 0, // 标线值
                        },
                        ],
                    },
                    data: 沪深300同比.filter(item => {
                        return parseFloat(item[0].substring(0, 4)) >= 2008
                    }).addStartEnd()
                },

                { //指数沪深300D
                    name: "沪深300",
                    type: "line",
                    lineStyle: {
                        width: 0,
                    },
                    itemStyle: {
                        normal: {
                            areaStyle: {
                                color: "#a3d4ff" // "#57aacb",
                            },
                        },
                        emphasis: {
                            areaStyle: {
                                color: "#a3d4ff",
                            },
                        },
                    },
                    showSymbol: false,
                    zlevel: 0,
                    xAxisIndex: 5,
                    yAxisIndex: 10,
                    data: 沪深300.map((item) => {
                        let tmp = []
                        tmp[0] = item.date
                        tmp[1] = item.close ? item.close : ""
                        return tmp
                    }).addStartEnd(),
                },
                { //指数上证D
                    name: "上证",
                    type: "line",
                    lineStyle: {
                        width: 0,
                    },
                    itemStyle: {
                        normal: {
                            areaStyle: {
                                color: "#a3d4ff"//"#87c5cf" // "#57aacb",
                            },
                        },
                        emphasis: {
                            areaStyle: {
                                color: "#a3d4ff",
                            },
                        },
                    },
                    showSymbol: false,
                    zlevel: 0,
                    xAxisIndex: 5,
                    yAxisIndex: 10,
                    data: 上证.map((item) => {
                        let tmp = []
                        tmp[0] = item.date
                        tmp[1] = item.close ? item.close : ""
                        return tmp
                    }).addStartEnd(),
                },



                { //pmi
                    name: 'pmi',
                    type: 'line',
                    xAxisIndex: 6,
                    yAxisIndex: 12,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 0.6,
                        color: "#ff66cc", //"black" //

                    },
                    zlevel: 1,
                    markLine: {
                        symbol: ["none", "none"],
                        data: [

                            {
                                lineStyle: {
                                    width: 0.5,
                                    color: "gray",
                                },
                                label: {
                                    formatter: "上穿10,15",
                                    color: "#ff535c",
                                    fontSize: 8,
                                    position: "insideStartTop",
                                },
                                yAxis: 15, // 标线值
                            },

                            {
                                lineStyle: {
                                    width: 0.5,
                                    color: "gray",
                                },
                                label: {
                                    formatter: "",
                                    color: "#ff535c",
                                    fontSize: 8,
                                    position: "insideStartTop",
                                },
                                yAxis: 10, // 标线值
                            },

                            {
                                lineStyle: {
                                    width: 0.5,
                                    color: "gray",
                                },
                                label: {
                                    formatter: "",
                                    color: "#0081B6",
                                    fontSize: 8,
                                    position: "insideStartBottom",
                                },
                                yAxis: -7, // 标线值
                            },

                            {
                                lineStyle: {
                                    width: 0.5,
                                    color: "gray",
                                },
                                label: {
                                    formatter: "下穿-7,-10",
                                    color: "#0081B6",
                                    fontSize: 8,
                                    position: "insideStartBottom",
                                },
                                yAxis: -10, // 标线值
                            }
                        ],
                    },
                    data: cn_pmi_平均.map(v => {
                        v[1] = parseFloat(v[1]) * 10
                        return v
                    }).addStartEnd(),
                },
                {
                    name: "汽车与出口",
                    type: "line",
                    xAxisIndex: 6,
                    yAxisIndex: 12,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: "black" //"#fd5f21", #fd9950
                    },
                    data: 零售汽车$出口.addStartEnd()
                },
                {
                    name: "房地产",
                    type: "line",
                    xAxisIndex: 6,
                    yAxisIndex: 12,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1.3,
                        color: "#ff4d57" //"#ff8c00"
                    },
                    data: 商品房销售.addStartEnd()
                },
                {
                    name: "MM制造业",
                    type: "line",
                    xAxisIndex: 6,
                    yAxisIndex: 12,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: "#565048",
                    },
                    markLine: {
                        symbol: ["none", "none"],
                        data: [
                            {
                                lineStyle: {
                                    width: 0.5,
                                    type: "solid",
                                    color: "black",
                                },

                                yAxis: 0, // 标线值
                            }
                        ]
                    },
                    zlevel: 1,
                    data: MM制造业指标.map((item) => {
                        item[1] = item[1] * 10
                        return item
                    }).addStartEnd()
                },


                { //信贷
                    name: '信贷脉冲',
                    type: 'line',
                    xAxisIndex: 7,
                    yAxisIndex: 14,
                    smooth: true,
                    showSymbol: false,
                    itemStyle: {
                        "color": {
                            "type": "linear",
                            "x": 0,
                            "y": 0,
                            "x2": 0,
                            "y2": 1,
                            "colorStops": [{
                                "offset": 0.7, //小上 大下
                                "color": "green"
                            },
                            {
                                "offset": 0.5,
                                "color": "orange"
                            },

                            {
                                "offset": 0.3,
                                "color": "red"
                            }

                            ],
                            "globalCoord": false
                        }

                    },
                    lineStyle: {
                        width: 1.5,

                    },
                    data: 信贷脉冲.addStartEnd()
                },
                {
                    name: '信贷脉冲_MA',
                    type: 'line',
                    xAxisIndex: 7,
                    yAxisIndex: 14,
                    smooth: true,
                    showSymbol: false,
                    itemStyle: {
                        "color": {
                            "type": "linear",
                            "x": 0,
                            "y": 0,
                            "x2": 0,
                            "y2": 1,
                            "colorStops": [{
                                "offset": 0.7,
                                "color": "green"
                            },
                            {
                                "offset": 0.5,
                                "color": "orange"
                            },

                            {
                                "offset": 0.3,
                                "color": "red"
                            }

                            ],
                            "globalCoord": false
                        }

                    },
                    lineStyle: {
                        width: 1.2,
                        type: 'dotted',

                    },
                    data: 信贷脉冲_MA.addStartEnd()
                },

                { //M1_2 
                    name: "M1_M2",
                    type: "line",
                    xAxisIndex: 7,
                    yAxisIndex: 15,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: "black", //"#ff4900",

                    },
                    data: M1_M2.addStartEnd(),
                },
                {
                    name: "M1_M2_MA",
                    type: "line",
                    xAxisIndex: 7,
                    yAxisIndex: 15,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 1.2,
                        type: 'dotted',
                        color: "black" //"#ff5c5c",

                    },
                    data: M1_M2_MA.addStartEnd(),
                },

                {
                    name: '金融脉动增速us',
                    type: 'line',
                    xAxisIndex: 7,
                    yAxisIndex: 15,
                    showSymbol: false,
                    //smooth: true,
                    lineStyle: {
                        width: 1,
                        color: "#565048",
                    },
                    data: 金融脉动增速.map((item) => {
                        item[1] = Number(item[1]) * -10
                        return item
                    }).addStartEnd()
                },
                {
                    name: "中美汇",
                    type: "line",
                    xAxisIndex: 7,
                    yAxisIndex: 15,
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        width: 0.8,
                        color: "gray"
                    },
                    data: 中美汇率Day同比.addStartEnd()
                },

            ]
        };

        if (option && typeof option === "object") {
            myChart.setOption(option);
        }
        window.addEventListener("resize", myChart.resize);

        myChart.on('legendselectchanged', function (params) {

            if (params.name === "中位PE" && params.selected["中位PE"] === true) {
                option.yAxis[4].max = 7.5
                option.yAxis[4].min = 0.5
                option.yAxis[4].inverse = true
                option.yAxis[4].interval = 1.5

                params.selected["股债差"] = false
                option.legend.selected = params.selected
                myChart.setOption(option)
            }

            if (params.name === "股债差" && params.selected["股债差"] === true) {
                option.yAxis[4].max = 9
                option.yAxis[4].min = 0
                option.yAxis[4].inverse = true
                option.yAxis[4].interval = 3

                params.selected.中位PE = false
                option.legend.selected = params.selected
                myChart.setOption(option)
            }

        })

        setTimeout(() => {
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "上证"
            });

            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "大盘策略"
            });

            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "汽车与出口"
            });

            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "房地产"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "中位PE"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "恒指美债差"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "美债"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "MM制造业"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "M1_M2"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "M1_M2_MA"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "信贷脉冲_MA"
            })
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "中美汇"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "美元指"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "金融脉动增速us"
            });
            myChart.dispatchAction({
                type: 'legendToggleSelect',
                name: "300同比"
            });
        }, "1")


        window.onload = () => {
            window.onresize = function (e) {
                //console.log("window.innerHeight",window.innerHeight) 
                if (window.innerHeight >= 767) {  //880
                    option.grid = grid全屏
                    myChart.setOption(option)
                    myChart.dispatchAction({
                        type: 'legendSelect',
                        name: "300同比"
                    });

                } else if (window.innerHeight < 767) {
                    option.grid = grid默认
                    myChart.setOption(option)
                    myChart.dispatchAction({
                        type: 'legendUnSelect',
                        name: "300同比"
                    });
                }
            }//onresize
        }
    </script>
</body>

</html>